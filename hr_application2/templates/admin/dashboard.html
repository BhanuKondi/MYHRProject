{% extends "admin/admin_base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h2 class="fw-bold">Attendance Dashboard</h2>
    <div class="text-end">
      <div id="digitalClock" class="h3 text-primary"></div>
      <div class="small text-muted" id="todayDate"></div>
    </div>
  </div>

  <!-- Attendance Controls and Timers -->
  <div class="card shadow p-4 mb-3">
    <div class="row align-items-center">
      <div class="col-auto mb-2">
        <button id="clockInBtn" class="btn btn-success btn-lg px-4 me-2">Clock In</button>
        <button id="clockOutBtn" class="btn btn-danger btn-lg px-4">Clock Out</button>
      </div>
      <div class="col d-flex justify-content-center gap-5 flex-wrap mb-2">
        <div class="text-center">
          <small class="text-muted">Current Session</small>
          <h3 id="sessionTime" class="fw-bold text-success">00:00:00</h3>
        </div>
        <div class="text-center">
          <small class="text-muted">Total Worked Today</small>
          <h3 id="totalWorkedTime" class="fw-bold text-primary">00:00:00</h3>
        </div>
      </div>
      <div class="col-12 text-center text-info" id="statusMessage"></div>
    </div>
  </div>

  <!-- Transactions Table -->
  <div class="card p-3 shadow-sm mb-3">
    <h5>Today's Transactions</h5>

    <div class="row g-2 mb-3">
      <div class="col-auto">
        <label for="fromDate" class="form-label">From:</label>
        <input type="date" id="fromDate" class="form-control form-control-sm">
      </div>
      <div class="col-auto">
        <label for="toDate" class="form-label">To:</label>
        <input type="date" id="toDate" class="form-control form-control-sm">
      </div>
      <div class="col-auto align-self-end">
        <button id="filterBtn" class="btn btn-primary btn-sm">Filter</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-bordered table-sm" id="txnTable">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Clock In</th>
            <th>Clock Out</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="mt-2 text-end fw-bold">
      Total Hours Worked Today: <span id="totalHoursWorked">00:00:00</span>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  let workTimerInterval = null;
  let previousWorkedSeconds = 0;

  function updateDigitalClock() {
    const now = new Date();
    document.getElementById("digitalClock").innerText = now.toLocaleTimeString("en-IN", { hour12: true });
    document.getElementById("todayDate").innerText = now.toLocaleDateString("en-IN");
  }
  setInterval(updateDigitalClock, 1000);
  updateDigitalClock();

  async function setButtonsFromStatus() {
    const res = await fetch("/attendance/status");
    const data = await res.json();
    document.getElementById("clockInBtn").disabled = data.active;
    document.getElementById("clockOutBtn").disabled = !data.active;
  }

  function stopWorkTimer() { clearInterval(workTimerInterval); workTimerInterval=null; }

  function startWorkTimer(clockInISO) {
    stopWorkTimer();
    const start = new Date(clockInISO);
    function tick() {
      const now = new Date();
      const diff = Math.floor((now - start) / 1000);
      const total = diff + previousWorkedSeconds;
      document.getElementById("sessionTime").innerText = formatHHMMSS(diff);
      document.getElementById("totalWorkedTime").innerText = formatHHMMSS(total);
    }
    tick();
    workTimerInterval = setInterval(tick, 1000);
  }

  function formatHHMMSS(sec) {
    const h = String(Math.floor(sec/3600)).padStart(2,"0");
    const m = String(Math.floor((sec%3600)/60)).padStart(2,"0");
    const s = String(sec%60).padStart(2,"0");
    return `${h}:${m}:${s}`;
  }

  function formatDurationDetail(sec) {
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    return `${h}h ${m}m ${s}s`;
  }

  async function loadTodaySummary() {
    const res = await fetch("/attendance/today-summary");
    const data = await res.json();
    previousWorkedSeconds = data.total_seconds || 0;
    document.getElementById("totalWorkedTime").innerText = formatHHMMSS(previousWorkedSeconds);

    const tbody = document.querySelector("#txnTable tbody");
    tbody.innerHTML = "";

    let totalSeconds = 0;
    data.transactions.forEach(tx=>{
      const tr = document.createElement("tr");
      const durationSec = tx.duration || 0;
      totalSeconds += durationSec;
      tr.innerHTML = `
        <td>${tx.transaction_no}</td>
        <td>${tx.clock_in}</td>
        <td>${tx.clock_out}</td>
        <td>${durationSec ? formatDurationDetail(durationSec) : '-'}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("totalHoursWorked").innerText = formatHHMMSS(totalSeconds);
  }

  async function loadCurrentSession() {
    const res = await fetch("/attendance/current");
    const data = await res.json();
    if(data.active) startWorkTimer(data.clock_in);
    else { stopWorkTimer(); document.getElementById("sessionTime").innerText="00:00:00"; }
  }

  document.getElementById("clockInBtn").addEventListener("click", async ()=>{
    const res = await fetch("/attendance/clock_in",{method:"POST"});
    const data = await res.json();
    if(!res.ok) return alert(data.error||"Clock In failed");
    await loadTodaySummary();
    await loadCurrentSession();
    await setButtonsFromStatus();
  });

  document.getElementById("clockOutBtn").addEventListener("click", async ()=>{
    stopWorkTimer();
    const res = await fetch("/attendance/clock_out",{method:"POST"});
    const data = await res.json();
    if(!res.ok) return alert(data.error||"Clock Out failed");
    await loadTodaySummary();
    await loadCurrentSession();
    await setButtonsFromStatus();
  });

  document.getElementById("filterBtn").addEventListener("click", async ()=>{
    const from=document.getElementById("fromDate").value;
    const to=document.getElementById("toDate").value;
    if(!from||!to) return alert("Select From & To dates");
    const res = await fetch(`/attendance/filter?from=${from}&to=${to}`);
    const data = await res.json();
    const tbody = document.querySelector("#txnTable tbody");
    tbody.innerHTML="";
    data.transactions.forEach(tx=>{
      const tr = document.createElement("tr");
      tr.innerHTML=`
        <td>${tx.transaction_no}</td>
        <td>${tx.clock_in}</td>
        <td>${tx.clock_out}</td>
        <td>${tx.duration===0?'-':formatDurationDetail(tx.duration)}</td>
      `;
      tbody.appendChild(tr);
    });
  });

  (async function init(){ await loadTodaySummary(); await loadCurrentSession(); await setButtonsFromStatus(); })();

});
</script>
{% endblock %}